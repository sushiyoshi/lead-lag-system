<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bode Plot</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="plot" style="width: 100%; height: 80vh;"></div>
    <div>
        <label for="m-slider">m: </label>
        <input type="range" id="m-slider" min="0.1" max="10.0" value="1.0" step="0.1" oninput="updatePlot()">
        <span id="m-value">1.0</span>
    </div>
    <div>
        <label for="T1-slider">T1: </label>
        <input type="range" id="T1-slider" min="0.01" max="10.0" value="1.0" step="0.01" oninput="updatePlot()">
        <span id="T1-value">0.1</span>
    </div>
    <div>
        <label for="T2-slider">T2: </label>
        <input type="range" id="T2-slider" min="0.01" max="10.0" value="0.1" step="0.01" oninput="updatePlot()">
        <span id="T2-value">0.001</span>
    </div>

    <script>
        function bodePlot(m, T1, T2) {
            const w = Array.from({length: 500}, (_, i) => Math.pow(10, -4 + i * 8 / 499));
            const C_s = w.map(wi => (math.complex(0, T1 * wi).add(1)).div(math.complex(0, T2 * wi).add(1)));
            const P_s = w.map(wi => math.divide(1, math.multiply(m, math.pow(math.complex(0, wi), 2))));
            const G_ol = C_s.map((ci, i) => math.multiply(ci, P_s[i]));

            const mag = G_ol.map(g => 20 * Math.log10(math.abs(g)));
            const phase = G_ol.map(g => math.arg(g) * 180 / Math.PI);

            return { w, mag, phase };
        }

        function updatePlot() {
            const m = parseFloat(document.getElementById('m-slider').value);
            const T1 = parseFloat(document.getElementById('T1-slider').value);
            const T2 = parseFloat(document.getElementById('T2-slider').value);
            document.getElementById('m-value').innerText = m;
            document.getElementById('T1-value').innerText = T1;
            document.getElementById('T2-value').innerText = T2;

            const { w, mag, phase } = bodePlot(m, T1, T2);

            const trace1 = {
                x: w,
                y: mag,
                type: 'scatter',
                mode: 'lines',
                name: 'Magnitude (dB)',
                line: { color: 'blue' }
            };

            const trace2 = {
                x: w,
                y: phase,
                type: 'scatter',
                mode: 'lines',
                name: 'Phase (degrees)',
                line: { color: 'red' },
                yaxis: 'y2'
            };

            const layout = {
                title: 'Bode Plot',
                xaxis: {
                    type: 'log',
                    title: 'Frequency (rad/s)',
                    autorange: true
                },
                yaxis: {
                    title: 'Magnitude (dB)',
                    autorange: true
                },
                yaxis2: {
                    title: 'Phase (degrees)',
                    overlaying: 'y',
                    side: 'right',
                    autorange: true
                }
            };

            Plotly.newPlot('plot', [trace1, trace2], layout);
        }

        // 初期プロットの描画
        updatePlot();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.5.0/math.min.js"></script>
</body>
</html>
